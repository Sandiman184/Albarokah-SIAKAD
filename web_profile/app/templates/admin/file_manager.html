{% extends "admin/layout.html" %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">File Manager</h1>
    <form action="{{ url_for('admin.file_delete_unused') }}" method="POST" onsubmit="return confirm('Apakah Anda yakin ingin menghapus SEMUA file yang tidak digunakan? Tindakan ini tidak dapat dibatalkan.');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-danger shadow-sm">
            <i class="fas fa-trash fa-sm text-white-50 me-1"></i> Bersihkan File Tidak Terpakai
        </button>
    </form>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3 bg-white d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-images me-2"></i>Galeri Media</h6>
        <span class="badge bg-secondary">{{ files|length }} File</span>
    </div>
    <div class="card-body">
        {% if files %}
        <div class="row">
            {% for file in files %}
            <div class="col-md-3 col-sm-6 mb-4 filter-item" data-category="{{ file.category }}">
                <div class="card h-100 shadow-sm">
                    <div class="position-relative">
                        <img src="{{ file.url }}" class="card-img-top" alt="{{ file.name }}" style="height: 150px; object-fit: cover;">
                        <span class="position-absolute top-0 end-0 badge rounded-pill m-2 {{ 'bg-success' if file.is_used else 'bg-secondary' }}">
                            {{ 'Digunakan' if file.is_used else 'Tidak Digunakan' }}
                        </span>
                    </div>
                    <div class="card-body p-2">
                        <h6 class="card-title text-truncate small mb-1" title="{{ file.name }}">{{ file.name }}</h6>
                        <p class="card-text small text-muted mb-2">{{ file.size }}</p>
                        
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="btn-group">
                                <a href="{{ file.url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Lihat">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="copyToClipboard('{{ file.url }}')" title="Salin Link">
                                    <i class="fas fa-link"></i>
                                </button>
                            </div>
                            <form action="{{ url_for('admin.file_delete') }}" method="POST" onsubmit="return confirm('{{ 'PERINGATAN: File ini sedang digunakan di website! ' if file.is_used else '' }}Yakin ingin menghapus file ini secara permanen?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="filepath" value="{{ file.path }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="fas fa-folder-open fa-4x mb-3 opacity-25"></i>
            <p>Belum ada file media yang diupload.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function copyToClipboard(text) {
    // Fallback for non-secure contexts (http) if clipboard API is blocked, 
    // but usually localhost is treated as secure.
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(function() {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Link Disalin!',
                    text: 'URL gambar telah disalin ke clipboard.',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                alert('Link berhasil disalin!');
            }
        }, function(err) {
            console.error('Async: Could not copy text: ', err);
            fallbackCopyTextToClipboard(text);
        });
    } else {
        fallbackCopyTextToClipboard(text);
    }
}

function fallbackCopyTextToClipboard(text) {
    var textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Avoid scrolling to bottom
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        var successful = document.execCommand('copy');
        if (successful) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Link Disalin!',
                    text: 'URL gambar telah disalin ke clipboard.',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                alert('Link berhasil disalin!');
            }
        } else {
            alert('Gagal menyalin link.');
        }
    } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        alert('Gagal menyalin link.');
    }

    document.body.removeChild(textArea);
}
</script>
{% endblock %}